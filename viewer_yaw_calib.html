<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AR Yaw Calib (A1/A2 – B1/B2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
    }

    #overlay-ui {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }

    #top-bar {
      position: absolute;
      top: env(safe-area-inset-top, 8px);
      left: 0;
      right: 0;
      text-align: center;
      font-size: 14px;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
      pointer-events: none;
    }

    #center-dot {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      pointer-events: none;
    }

    #bottom-bar {
      position: absolute;
      bottom: env(safe-area-inset-bottom, 12px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: auto;
    }

    #instruction {
      font-size: 11px;
      text-align: center;
      max-width: 90vw;
      opacity: 0.9;
    }

    #controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 12px;
    }

    button {
      min-width: 120px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #007aff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      box-shadow: none;
    }

    #status-label {
      font-size: 11px;
      opacity: 0.9;
      text-align: center;
    }

    #result-label {
      font-size: 11px;
      opacity: 0.9;
      text-align: center;
      max-width: 95vw;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div id="overlay-ui">
    <div id="top-bar">A1/A2 ↔ B1/B2 Yaw 보정 테스트</div>
    <!-- 화면 중앙 고정 점 -->
    <div id="center-dot"></div>

    <div id="bottom-bar">
      <div id="instruction">
        처음에는 [START AR]를 눌러 AR을 시작합니다.<br/>
        AR 시작 후에는 왼쪽에서 B1/B2를 고르고 [선택]으로 찍으세요.
      </div>

      <div id="controls">
        <select id="point-select" disabled>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
        </select>
        <button id="main-button">START AR</button>
      </div>

      <div id="status-label">상태: 준비 완료</div>
      <div id="result-label"></div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js";

    // ---------------- 기본 three.js / WebXR 세팅 ----------------
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 50);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(light);

    // 바닥 hit-test용 3D 레티클 (원)
    const reticle3D = new THREE.Mesh(
      new THREE.RingGeometry(0.03, 0.035, 32),
      new THREE.MeshBasicMaterial({ color: 0xffffff })
    );
    reticle3D.rotation.x = -Math.PI / 2;
    reticle3D.visible = false;
    scene.add(reticle3D);

    // ---------------- 도면 기준점 A1 / A2 (mm → m 상수) ----------------
    // 최신 Office_2.json 기준:
    // A2 ≈ (0, 0), A1 ≈ (1500, 0)  (단위: mm)
    const MM_TO_M = 0.001;

    const A1_PLAN = new THREE.Vector2(1500 * MM_TO_M, 0 * MM_TO_M); // (1.5m, 0)
    const A2_PLAN = new THREE.Vector2(0 * MM_TO_M,    0 * MM_TO_M); // (0, 0)

    // ---------------- AR / Hit-test 상태 ----------------
    let xrSession = null;
    let xrRefSpace = null;
    let hitTestSource = null;
    let hitTestSourceRequested = false;

    // B1 / B2 월드 좌표 (m)
    let B1_world = null;
    let B2_world = null;

    const pointSelect = document.getElementById("point-select");
    const mainButton = document.getElementById("main-button");
    const statusLabel = document.getElementById("status-label");
    const resultLabel = document.getElementById("result-label");

    function setStatus(msg) {
      statusLabel.textContent = "상태: " + msg;
      console.log("[STATUS]", msg);
    }

    function setResult(msg) {
      resultLabel.textContent = msg;
      console.log("[RESULT]\n" + msg);
    }

    // ---------------- START AR / 선택 버튼 ----------------
    let isARStarted = false; // 한 번만 START AR 용도로 사용

    mainButton.addEventListener("click", () => {
      if (!isARStarted) {
        startAR();
      } else {
        selectCurrentPoint();
      }
    });

    function startAR() {
      if (!navigator.xr) {
        setStatus("WebXR 지원 안함");
        return;
      }

      const sessionInit = {
        requiredFeatures: ["hit-test"],
        optionalFeatures: ["dom-overlay"],
        domOverlay: { root: document.body }
      };

      navigator.xr.requestSession("immersive-ar", sessionInit)
        .then((session) => {
          xrSession = session;
          renderer.xr.setReferenceSpaceType("local");
          renderer.xr.setSession(session);

          session.addEventListener("end", () => {
            xrSession = null;
            xrRefSpace = null;
            hitTestSource = null;
            hitTestSourceRequested = false;
            reticle3D.visible = false;
            isARStarted = false;
            mainButton.textContent = "START AR";
            pointSelect.disabled = true;
            setStatus("AR 세션 종료");
          });

          // reference space
          session.requestReferenceSpace("local").then((refSpace) => {
            xrRefSpace = refSpace;
          });

          isARStarted = true;
          mainButton.textContent = "선택";
          pointSelect.disabled = false;
          setStatus("바닥을 향해 움직여 레티클이 보이게 한 뒤, B1/B2를 선택하세요.");
        })
        .catch((err) => {
          console.error(err);
          setStatus("AR 세션 시작 실패");
        });
    }

    function selectCurrentPoint() {
      if (!reticle3D.visible) {
        setStatus("바닥 Hit-test가 아직 없습니다. 카메라를 바닥으로 움직여 보세요.");
        return;
      }

      const pos = reticle3D.position.clone();
      const target = pointSelect.value; // "B1" 또는 "B2"

      if (target === "B1") {
        B1_world = pos;
        setStatus(`B1 저장: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})`);
      } else if (target === "B2") {
        B2_world = pos;
        setStatus(`B2 저장: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})`);
      }

      // 두 점 모두 준비되면 계산
      if (B1_world && B2_world) {
        computeYawAndScale();
      }
    }

    // ---------------- yaw 및 스케일 계산 (전략1 + yaw-only) ----------------
    function computeYawAndScale() {
      // 도면 A1→A2 (2D, XY 평면)
      const vPlan = new THREE.Vector2(
        A2_PLAN.x - A1_PLAN.x,
        A2_PLAN.y - A1_PLAN.y
      );
      const lenPlan = vPlan.length();

      // 월드 B1→B2 (수평면 XZ에 투영)
      const vWorld2D = new THREE.Vector2(
        B2_world.x - B1_world.x,
        B2_world.z - B1_world.z
      );
      const lenWorld = vWorld2D.length();

      if (lenPlan === 0 || lenWorld === 0) {
        setResult("길이가 0인 벡터가 있어서 계산할 수 없습니다.");
        return;
      }

      const scale = lenWorld / lenPlan; // 도면 길이 → 실세계 길이 비율

      const anglePlan = Math.atan2(vPlan.y, vPlan.x);
      const angleWorld = Math.atan2(vWorld2D.y, vWorld2D.x);
      const yaw = angleWorld - anglePlan; // rad

      const yawDeg = yaw * 180 / Math.PI;

      const msg =
        `A1 = (${A1_PLAN.x.toFixed(3)}, ${A1_PLAN.y.toFixed(3)}) m\n` +
        `A2 = (${A2_PLAN.x.toFixed(3)}, ${A2_PLAN.y.toFixed(3)}) m\n` +
        `도면 A1–A2 길이 = ${lenPlan.toFixed(3)} m\n\n` +
        `B1 = (${B1_world.x.toFixed(3)}, ${B1_world.y.toFixed(3)}, ${B1_world.z.toFixed(3)}) m\n` +
        `B2 = (${B2_world.x.toFixed(3)}, ${B2_world.y.toFixed(3)}, ${B2_world.z.toFixed(3)}) m\n` +
        `실세계 B1–B2 길이 = ${lenWorld.toFixed(3)} m\n\n` +
        `스케일(scale) = ${scale.toFixed(5)}\n` +
        `Yaw(라디안) = ${yaw.toFixed(5)}\n` +
        `Yaw(도) = ${yawDeg.toFixed(3)}°`;

      setResult(msg);
      setStatus("계산 완료. 위 결과를 도면 정합에 사용할 수 있습니다.");
    }

    // ---------------- 렌더 루프 / hit-test ----------------
    renderer.setAnimationLoop((time, frame) => {
      const session = renderer.xr.getSession();
      if (!session || !frame || !xrRefSpace) {
        renderer.render(scene, camera);
        return;
      }

      if (!hitTestSourceRequested) {
        session.requestReferenceSpace("viewer").then((viewerSpace) => {
          session
            .requestHitTestSource({ space: viewerSpace })
            .then((source) => {
              hitTestSource = source;
            })
            .catch((err) => console.error("HitTestSource 오류:", err));
        });
        hitTestSourceRequested = true;
      }

      if (hitTestSource && xrRefSpace) {
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length > 0) {
          const hit = hits[0];
          const pose = hit.getPose(xrRefSpace);
          if (pose) {
            const mat = new THREE.Matrix4().fromArray(pose.transform.matrix);
            reticle3D.visible = true;
            reticle3D.position.setFromMatrixPosition(mat);
          }
        } else {
          reticle3D.visible = false;
        }
      }

      renderer.render(scene, camera);
    });

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
